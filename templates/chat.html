{% extends "base.html" %}
{% block content %}
<div class="card" style="height: 80vh;">
    <div class="card-header bg-black text-success border-success">
        <span>/// SECURE CHANNEL: GEMINI-2.5-FLASH ///</span>
    </div>
    <div id="chat-box" class="card-body overflow-auto" style="background-color: #050505;">
        {% for msg in history %}
            <div class="mb-3 {% if msg.role == 'user' %}text-end{% else %}text-start{% endif %}">
                <span class="badge {% if msg.role == 'user' %}bg-success text-black{% else %}bg-secondary{% endif %} mb-1">
                    {{ 'COMMANDER' if msg.role == 'user' else 'AI UNIT' }}
                </span>
                <div class="p-2 rounded {% if msg.role == 'user' %}bg-dark border border-success text-success{% else %}bg-black border border-secondary text-light{% endif %} d-inline-block">
                    {{ msg.content }}
                </div>
            </div>
        {% endfor %}
    </div>
    <div class="card-footer bg-black border-success">
        <form id="chat-form" class="input-group">
            <input type="text" id="user-input" class="form-control" placeholder="Enter command..." required autocomplete="off">
            <button type="submit" class="btn btn-primary">TRANSMIT</button>
        </form>
    </div>
</div>
<script>
    const box = document.getElementById('chat-box');
    box.scrollTop = box.scrollHeight;
    document.getElementById('chat-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const inp = document.getElementById('user-input');
        const msg = inp.value.trim();
        if (!msg) return;

        append(msg, 'user');
        inp.value = '';

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({'user_input': msg})
            });
            const data = await res.json();
            append(data.response || data.error, 'ai');
        } catch (err) { append('COMM ERROR', 'ai'); }
    });

    function append(text, role) {
        const isUser = role === 'user';
        const html = `
            <div class="mb-3 ${isUser ? 'text-end' : 'text-start'}">
                <span class="badge ${isUser ? 'bg-success text-black' : 'bg-secondary'} mb-1">${isUser ? 'COMMANDER' : 'AI UNIT'}</span>
                <div class="p-2 rounded d-inline-block ${isUser ? 'bg-dark border border-success text-success' : 'bg-black border border-secondary text-light'}">
                    ${text}
                </div>
            </div>`;
        box.insertAdjacentHTML('beforeend', html);
        box.scrollTop = box.scrollHeight;
    }
</script>
{% endblock %}
